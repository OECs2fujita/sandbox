name: Slack chat.postMessage
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      CHANNEL_ID: C03HTB5869H # 通知を送りたいチャンネルのIDを指定する
    steps:
      - uses: actions/checkout@v2

      - name: Set COMMIT_MESSAGE
        run: echo "COMMIT_MESSAGE=${{ github.event.head_commit.message }}" >> $GITHUB_ENV

      - name: Slack Notification on Success
        if: success()
        uses: slackapi/slack-github-action@v1.19.0
        with:
          channel-id: ${{ env.CHANNEL_ID }}
          payload: |
            {
              "text": "Build & Deploy Success!!",
              "attachments": [
                {
                  "color": "00FF00",
                  "author_name": "${{ github.actor }}",
                  "author_icon": "${{ github.event.sender.avatar_url }}",
                  "fields": [
                    {
                      "title": "Commit Message",
                      "value": "${{ env.COMMIT_MESSAGE }}",
                      "short": false
                    },
                    {
                      "title": "GitHub Actions URL",
                      "value": "<${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}>",
                      "short": false
                    },
                    { 
                      "title": "Compare URL",
                      "value": "${{ github.event.compare }}",
                      "short": false
                    }
                  ]
                }
              ]
            }

      - name: Slack Notification on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.19.0
        with:
          channel-id: ${{ env.CHANNEL_ID }}
          payload: |
            {
              "text": "Build & Deploy Failure...",
              "attachments": [
                {
                  "color": "FF0000",
                  "author_name": "${{ github.actor }}",
                  "author_icon": "${{ github.event.sender.avatar_url }}",
                  "fields": [
                    {
                      "title": "Commit Message",
                      "value": "${{ env.COMMIT_MESSAGE }}",
                      "short": false
                    },
                    {
                      "value": "<${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}>",
                      "title": "GitHub Actions URL",
                      "short": false
                    },
                    {
                      "value": "${{ github.event.compare }}",
                      "title": "Compare URL",
                      "short": false
                    }
                  ]
                }
              ]
            }
